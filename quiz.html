<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>優香の 一問一答（カテゴリ別）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      max-width: 800px;
      margin: 24px auto;
      padding: 0 16px 40px;
      line-height: 1.6;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 18px;
      margin-top: 24px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .subtitle {
      color: #555;
      font-size: 13px;
      margin-bottom: 16px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
      background: #fafafa;
    }
    .label {
      font-size: 12px;
      color: #777;
    }
    .question {
      font-size: 24px;
      font-weight: 600;
      margin: 8px 0 4px;
    }
    .meaning {
      font-size: 18px;
      margin-top: 8px;
    }
    .pos {
      color: #888;
      font-size: 12px;
      text-transform: lowercase;
    }
    .pos-val {
      color: #888;
      font-size: 12px;
      text-transform: lowercase;
    }
    .details {
      margin-top: 10px;
    }
  
    .details summary {
      cursor: pointer;
      color: #555;
      font-size: 13px;
      font-weight: 400;
    }
    .details .box {
      margin-top: 6px;
      padding-top: 8px;
      border-top: 1px dashed #ddd;
      white-space: pre-wrap;
      font-size: 13px;
      color: #333;
  }

    .reading {
      font-size: 14px;
      color: #555;
    }
    .note {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    button {
      border-radius: 999px;
      border: 1px solid #ccc;
      padding: 6px 14px;
      margin: 4px 4px 4px 0;
      font-size: 13px;
      cursor: pointer;
      background: white;
    }
    button.primary {
      background: #222;
      color: white;
      border-color: #222;
    }
    button.good {
      background: #1a7f37;
      color: white;
      border-color: #1a7f37;
    }
    button.bad {
      background: #b91c1c;
      color: white;
      border-color: #b91c1c;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .small {
      font-size: 12px;
      color: #777;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 4px 2px;
      text-align: left;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      color: #555;
    }
    .center { text-align: center; }
    .toolbar { font-size: 13px; margin-bottom: 12px; }
    a.home-link {
      display: inline-block;
      margin-bottom: 16px;
      font-size: 14px;
      color: #2563eb;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <a href="index.html" class="home-link">← トップページに戻る</a>

  <h1>一問一答：<span id="category-title">読み込み中…</span></h1>
  <div class="subtitle" id="subtitle">
    ・英語 → 日本語／カタカナ読みのクイズ<br>
    ・「次の問題」または「答えを見る → 正解/不正解」で出題が進みます。<br>
    ・成績はブラウザに保存されます（同じPC・同じブラウザなら残る）。
  </div>

  <div class="toolbar small" id="toolbar-info"></div>

  <!-- クイズ画面 -->
  <div id="quiz-section">
    <h2>問題</h2>
    <div class="card" id="quiz-card">
      <div class="label">問題（英語）</div>
      <div class="question" id="question-word">—</div>
      <div class="small" id="question-index">—</div>

      <div id="answer-area" style="display:none; margin-top: 8px;">
        <div class="label">意味</div>
        <div class="meaning" id="answer-meaning">—</div>
        <div class="reading" id="answer-reading"></div>
        <div class="small" id="answer-stats"></div>
      </div>

      <div style="margin-top: 12px;">
        <button class="primary" id="next-btn" disabled>次の問題</button>
        <button id="show-btn" disabled>答えを見る</button>
        <button class="good" id="correct-btn" disabled>正解</button>
        <button class="bad" id="wrong-btn" disabled>不正解</button>
      </div>
    </div>

    <button id="open-stats-btn">このカテゴリの成績一覧を開く</button>
  </div>

  <!-- 成績一覧画面 -->
  <div id="stats-section" style="display:none;">
    <h2>単語一覧（成績）</h2>
    <div class="small">
      ※現在のカテゴリだけ表示しています。<br>
      ※正解数・挑戦数はクイズで回答すると自動更新されます。
    </div>
    <div id="table-container" style="margin-top:8px;"></div>
    <div style="margin-top:12px;">
      <button id="back-to-quiz-btn">クイズ画面に戻る</button>
    </div>
  </div>

  <script>
    // カテゴリごとの設定
    const CATEGORY_CONFIG = {
      psycho:    { file: "data/psycho.json",    label: "精神分析×文学 英単語" },
      waseda2024:{ file: "data/waseda2024.json",label: "早稲田 一般英語 2024" },
      waseda2025:{ file: "data/waseda2025.json",label: "早稲田 一般英語 2025" },
      basic_L1: { file: "data/basic_L1.json", label: "基礎英語 Lv.1（CEFR A1–A2）" },
      basic_L2: { file: "data/basic_L2.json", label: "基礎英語 Lv.2（CEFR B1）" },
      
      cefr_b1:   { file: "data/words_cefr_b1.json",label: "CEFR B1│基礎英語（頻出・共通）"},


    };

    // 成績保存用キー（カテゴリ-id で保存）
    const STATS_KEY = "yuka_eitan_quiz_stats_v2";

    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    const category = getQueryParam("cat") || "psycho";
    const categoryConfig = CATEGORY_CONFIG[category] || CATEGORY_CONFIG["psycho"];

    const categoryTitleEl = document.getElementById("category-title");
    const toolbarInfoEl   = document.getElementById("toolbar-info");

    categoryTitleEl.textContent = categoryConfig.label;
    toolbarInfoEl.textContent   = `カテゴリ: ${category} ／ ファイル: ${categoryConfig.file}`;

    let cards = [];
    let stats = loadStats();

    function loadStats() {
      try {
        const raw = localStorage.getItem(STATS_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        return {};
      }
    }

    function saveStats() {
      try {
        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
      } catch (e) {
        console.warn("成績の保存に失敗しました", e);
      }
    }

    function statKey(card) {
      return `${category}-${card.id}`;
    }

    function getCardStats(card) {
      const key = statKey(card);
      if (!stats[key]) stats[key] = { correct: 0, total: 0 };
      return stats[key];
    }

    // DOM要素
    const qWordEl      = document.getElementById("question-word");
    const qIndexEl     = document.getElementById("question-index");
    const ansAreaEl    = document.getElementById("answer-area");
    const ansMeaningEl = document.getElementById("answer-meaning");
    const ansReadingEl = document.getElementById("answer-reading");
    const ansStatsEl   = document.getElementById("answer-stats");

    const nextBtn      = document.getElementById("next-btn");
    const showBtn      = document.getElementById("show-btn");
    const correctBtn   = document.getElementById("correct-btn");
    const wrongBtn     = document.getElementById("wrong-btn");

    const quizSection  = document.getElementById("quiz-section");
    const statsSection = document.getElementById("stats-section");
    const openStatsBtn = document.getElementById("open-stats-btn");
    const backToQuizBtn= document.getElementById("back-to-quiz-btn");
    const tableContainer = document.getElementById("table-container");

    let currentCard = null;

    function pickRandomCard() {
      if (!cards.length) return null;
      const idx = Math.floor(Math.random() * cards.length);
      return cards[idx];
    }

    function showNewQuestion() {
      const card = pickRandomCard();
      if (!card) {
        qWordEl.textContent = "このカテゴリにはまだ単語がありません。";
        qIndexEl.textContent = "";
        ansAreaEl.style.display = "none";
        showBtn.disabled = true;
        correctBtn.disabled = true;
        wrongBtn.disabled = true;
        return;
      }
      currentCard = card;
      const index = cards.findIndex(c => c.id === card.id) + 1;

      qWordEl.textContent = card.en;
      qIndexEl.textContent = `No.${cards.findIndex(c => c.id === card.id) + 1} / 全${cards.length}語`;


      ansAreaEl.style.display = "none";
      ansMeaningEl.textContent = "";
      ansReadingEl.textContent = "";
      ansNoteEl.textContent = "";
      ansStatsEl.textContent = "";

      showBtn.disabled = false;
      correctBtn.disabled = true;
      wrongBtn.disabled = true;
    }

    function escapeHtml(s) {
  return String(s)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
}

   function formatPos(posArray) {
  if (!Array.isArray(posArray) || !posArray.length) return "";

  const POS_MAP = {
    v:   "動詞",
    n:   "名詞",
    adj: "形容詞",
    adv: "副詞",
    prep:"前置詞",
    conj:"接続詞"
  };

  return posArray.map(p => {
    const key = p.toLowerCase();
    const jp  = POS_MAP[key] || "品詞";
    return `${jp}（${key}）`;
  }).join(" / ");
}

   function showAnswer() {
  if (!currentCard) return;

  const s = getCardStats(currentCard);
  const rate = s.total > 0 ? Math.round((s.correct / s.total) * 100) + "%" : "—";

  const jpText = currentCard.jp ? `【基本】 ${escapeHtml(currentCard.jp)}` : "";

  // POS：小文字表示（V→v みたいに）
  const posText =
    Array.isArray(currentCard.pos) && currentCard.pos.length
    ? `<div class="pos">POS：${formatPos(currentCard.pos)}</div>`
    : "";


  const commonText =
    Array.isArray(currentCard.common) && currentCard.common.length
      ? `【用法】 ${escapeHtml(currentCard.common.join(" / "))}`
      : "";

  // 折りたたみ（補足）
  const noteHTML = currentCard.note
    ? `
      <details class="details">
        <summary>補足</summary>
        <div class="box">${escapeHtml(currentCard.note)}</div>
      </details>
    `
    : "";

  // ✅ 意味エリアは HTML で表示する（ここが最重要）
  const meaningHTML = [jpText ? `<div>${jpText}${posText}</div>` : "", commonText ? `<div>${commonText}</div>` : "", noteHTML]
    .filter(Boolean)
    .join("");

  ansMeaningEl.innerHTML = meaningHTML;

  // 読み
  ansReadingEl.textContent = currentCard.kana ? `読み：${currentCard.kana}` : "";

  // 成績
  ansStatsEl.textContent = `これまでの成績：正解 ${s.correct} / 挑戦 ${s.total}（正解率 ${rate}）`;
  ansAreaEl.style.display = "block";

  showBtn.disabled = true;
  correctBtn.disabled = false;
  wrongBtn.disabled = false;
}


  

    function recordAnswer(isCorrect) {
      if (!currentCard) return;
      const s = getCardStats(currentCard);
      s.total += 1;
      if (isCorrect) s.correct += 1;
      saveStats();
      refreshTable();

      correctBtn.disabled = true;
      wrongBtn.disabled = true;

      ansStatsEl.textContent += " ／ 記録しました。次の問題に進みます…";
      setTimeout(showNewQuestion, 400);
    }

    function refreshTable() {
      if (!cards.length) {
        tableContainer.innerHTML = "<p class='small'>まだ単語データがありません。</p>";
        return;
      }
      let html = "<table><thead><tr>" +
        "<th>英語</th><th>意味</th>" +
        "<th class='center'>正解</th><th class='center'>挑戦</th><th class='center'>正解率</th>" +
        "</tr></thead><tbody>";

      cards.forEach(card => {
        const s = getCardStats(card);
        const rate = s.total > 0 ? Math.round((s.correct / s.total) * 100) + "%" : "—";
        html += `<tr>
          <td>${escapeHtml(card.en)}</td>
          <td>${escapeHtml([card.jp, ...(Array.isArray(card.common) ? card.common : [])].filter(Boolean).join(" / "))}</td>
          <td class="center">${s.correct}</td>
          <td class="center">${s.total}</td>
          <td class="center">${rate}</td>
        </tr>`;
      });

      html += "</tbody></table>";
      tableContainer.innerHTML = html;
    }

    // 画面切り替え
    function showStats() {
      quizSection.style.display  = "none";
      statsSection.style.display = "block";
      refreshTable();
    }
    function showQuiz() {
      quizSection.style.display  = "block";
      statsSection.style.display = "none";
      showNewQuestion();
    }

    openStatsBtn.addEventListener("click", showStats);
    backToQuizBtn.addEventListener("click", showQuiz);

    nextBtn.addEventListener("click", showNewQuestion);
    showBtn.addEventListener("click", showAnswer);
    correctBtn.addEventListener("click", () => recordAnswer(true));
    wrongBtn.addEventListener("click", () => recordAnswer(false));

    // JSON を読み込んでスタート
    async function loadCardsFromJson() {
      try {
        const res = await fetch(categoryConfig.file);
        if (!res.ok) throw new Error("HTTP " + res.status);
        cards = await res.json();
        toolbarInfoEl.textContent += ` ／ 読み込み済み：${cards.length}語`;
      } catch (e) {
        qWordEl.textContent = "単語データの読み込みに失敗しました。";
        qIndexEl.textContent = "";
        toolbarInfoEl.textContent += " ／ 読み込みエラー";
        console.error(e);
        return;
      }
      nextBtn.disabled    = false;
      showBtn.disabled    = false;
      showNewQuestion();
    }

    loadCardsFromJson();
    window.addEventListener("pageshow", (e) => {
  // iOS Safari が「戻る/進む/復元」でDOM状態を保持したまま戻す対策
  if (e.persisted) location.reload();
});

  </script>
</body>
</html>
