<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>LEXICON.｜QUIZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="./ui/css/base.css">
</head>
<body class="quiz-page">
  <div class="main-wrapper">
  <header class="quiz-header">
      <a href="index.html" class="home-link">← 戻る</a>
      <h1 id="category-title" class="category-title-centered">読み込み中…</h1>
      <div style="width: 60px;"></div> </header>

    <div id="quiz-section">
      <div class="progress-bar-area">
        <span class="level-badge" id="question-index">NO.—</span>
      </div>

      <div class="card quiz-card" id="quiz-card">
        <div class="question-container">
          <div class="field-label-en" style="color: var(--muted); margin-bottom: 12px;">QUESTION</div>
          <div class="question-word" id="question-word">Loading...</div>
        </div>

        <div id="answer-area" class="answer-reveal-area" style="display:none;">
          <div class="divider-with-icon">
            <span>ANSWER REVEALED</span>
          </div>
          
          <div class="meaning-content" id="answer-meaning"></div>
          <div class="reading-accent" id="answer-reading"></div>
          <div class="stats-mini-note" id="answer-stats"></div>
        </div>
      </div>

      <div class="control-panel">
        <div class="main-controls">
          <button class="primary large" id="show-btn" disabled>SHOW ANSWER</button>
        </div>
        
        <div class="judge-controls">
          <button class="btn-correct" id="correct-btn" disabled>
            <span class="icon">✓</span> CORRECT
          </button>
          <button class="btn-wrong" id="wrong-btn" disabled>
            <span class="icon">×</span> WRONG
          </button>
        </div>

        <div class="sub-controls">
          <button class="btn-text" id="next-btn" disabled>SKIP →</button>
        </div>
      </div>

      <button id="open-stats-btn" class="secondary-outline" style="margin-top: 24px; font-size: 12px; font-weight: 800; letter-spacing: 0.1em;">
        VIEW SESSION STATS
      </button>
    </div>

    <div id="stats-section" style="display:none;">
      <div class="section-header">
        <h2 class="field-label-en" style="font-size: 16px;">SESSION PERFORMANCE</h2>
        <button id="back-to-quiz-btn" class="btn-text">← BACK TO TRAINING</button>
      </div>
      <div class="scroll-container card">
        <div id="table-container"></div>
      </div>
    </div>

    <footer class="system-info" style="margin-top: 40px;">
      <details>
        <summary class="field-label-en" style="cursor: pointer; opacity: 0.5;">SYSTEM DIAGNOSTICS</summary>
        <div id="toolbar-info" class="small" style="padding-top: 10px;"></div>
      </details>
    </footer>
  </div>
  <script>
    /* --- JavaScriptは元のロジックを100%継承 --- */
    // (ここに優香さんが貼ってくれた <script> の中身をそのまま入れます)
    // ※ 変更点: formatPos関数内で返すHTMLにクラスを少し足すとより綺麗になります
    
   const CATEGORY_CONFIG = {
      basic_L1:  { file: "data/basic_L1.json",  label: "基礎英語 Lv.1" },
      basic_L2:  { file: "data/basic_L2.json",  label: "基礎英語 Lv.2" },
      waseda2024:{ file: "data/waseda2024.json", label: "早稲田 2024" },
      waseda2025:{ file: "data/waseda2025.json", label: "早稲田 2025" },
      psycho:    { file: "data/psycho.json",     label: "精神分析 × 文学" },
      cefr_b1:   { file: "data/words_cefr_b1.json", label: "CEFR B1 頻出" }
 };


    const STATS_KEY = "yuka_eitan_quiz_stats_v2";
    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }
    const category = getQueryParam("cat") || "psycho";
    const categoryConfig = CATEGORY_CONFIG[category] || CATEGORY_CONFIG["psycho"];
    const categoryTitleEl = document.getElementById("category-title");
    const toolbarInfoEl   = document.getElementById("toolbar-info");
    categoryTitleEl.textContent = categoryConfig.label;
    toolbarInfoEl.textContent   = `カテゴリ: ${category} ／ ファイル: ${categoryConfig.file}`;

    let cards = [];
    let stats = loadStats();
    function loadStats() {
      try { const raw = localStorage.getItem(STATS_KEY); return raw ? JSON.parse(raw) : {}; } catch (e) { return {}; }
    }
    function saveStats() { try { localStorage.setItem(STATS_KEY, JSON.stringify(stats)); } catch (e) {} }
    function statKey(card) { return `${category}-${card.id}`; }
    function getCardStats(card) {
      const key = statKey(card);
      if (!stats[key]) stats[key] = { correct: 0, total: 0 };
      return stats[key];
    }

    const qWordEl = document.getElementById("question-word");
    const qIndexEl = document.getElementById("question-index");
    const ansAreaEl = document.getElementById("answer-area");
    const ansMeaningEl = document.getElementById("answer-meaning");
    const ansReadingEl = document.getElementById("answer-reading");
    const ansStatsEl = document.getElementById("answer-stats");
    const nextBtn = document.getElementById("next-btn");
    const showBtn = document.getElementById("show-btn");
    const correctBtn = document.getElementById("correct-btn");
    const wrongBtn = document.getElementById("wrong-btn");
    const quizSection = document.getElementById("quiz-section");
    const statsSection = document.getElementById("stats-section");
    const openStatsBtn = document.getElementById("open-stats-btn");
    const backToQuizBtn = document.getElementById("back-to-quiz-btn");
    const tableContainer = document.getElementById("table-container");

    let currentCard = null;
    function pickRandomCard() { if (!cards.length) return null; return cards[Math.floor(Math.random() * cards.length)]; }
    function showNewQuestion() {
      const card = pickRandomCard();
      if (!card) { qWordEl.textContent = "データがありません。"; return; }
      currentCard = card;
      const index = cards.findIndex(c => c.id === card.id) + 1;
      qWordEl.textContent = card.en;
      qIndexEl.textContent = `No.${index} / ${cards.length}`;
      ansAreaEl.style.display = "none";
      nextBtn.disabled = false;
      showBtn.disabled = false;
      correctBtn.disabled = true;
      wrongBtn.disabled = true;
    }
    function escapeHtml(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function formatPos(posArray) {
  if (!Array.isArray(posArray) || !posArray.length) return "";
  
  const POS_MAP = {
    v:    "動詞",
    n:    "名詞",
    adj:  "形容詞",
    adv:  "副詞",
    prep: "前置詞",
    conj: "接続詞"
  };

  return posArray.map(p => {
    const key = p.toLowerCase();
    const jp  = POS_MAP[key] || "品詞";
    // ここで「日本語（略称）」の形に組み立てます
    return `<span class="pos-tag">${jp}（${key}）</span>`;
  }).join(" ");
}
    function showAnswer() {
      if (!currentCard) return;
      const s = getCardStats(currentCard);
      const rate = s.total > 0 ? Math.round((s.correct / s.total) * 100) + "%" : "—";
      const jpText = currentCard.jp ? `<div class="jp-main">${escapeHtml(currentCard.jp)}</div>` : "";
      const posText = Array.isArray(currentCard.pos) ? `<div class="pos-container">${formatPos(currentCard.pos)}</div>` : "";
      const commonText = Array.isArray(currentCard.common) ? `<div class="common-usage">${escapeHtml(currentCard.common.join(" / "))}</div>` : "";
      const noteHTML = currentCard.note ? `<details class="note-details"><summary>補足メモ</summary><div class="note-box">${escapeHtml(currentCard.note)}</div></details>` : "";

      ansMeaningEl.innerHTML = jpText + posText + commonText + noteHTML;
      ansReadingEl.textContent = currentCard.kana ? `[ ${currentCard.kana} ]` : "";
      ansStatsEl.innerHTML = `正解率: <strong>${rate}</strong> (正解 ${s.correct} / 挑戦 ${s.total})`;
      ansAreaEl.style.display = "block";
      showBtn.disabled = true;
      correctBtn.disabled = false;
      wrongBtn.disabled = false;
    }
    function recordAnswer(isCorrect) {
      if (!currentCard) return;
      const s = getCardStats(currentCard);
      s.total += 1; if (isCorrect) s.correct += 1;
      saveStats();
      correctBtn.disabled = true; wrongBtn.disabled = true;
      setTimeout(showNewQuestion, 400);
    }
    function refreshTable() {
      if (!cards.length) return;
      let html = "<table class='stats-table'><thead><tr><th>単語</th><th>意味</th><th>率</th></tr></thead><tbody>";
      cards.forEach(card => {
        const s = getCardStats(card);
        const rate = s.total > 0 ? Math.round((s.correct / s.total) * 100) + "%" : "—";
        html += `<tr><td><b>${escapeHtml(card.en)}</b></td><td class='small'>${escapeHtml(card.jp)}</td><td class='center'>${rate}</td></tr>`;
      });
      tableContainer.innerHTML = html + "</tbody></table>";
    }
    function showStats() { quizSection.style.display="none"; statsSection.style.display="block"; refreshTable(); }
    function showQuiz() { quizSection.style.display="block"; statsSection.style.display="none"; }
    openStatsBtn.addEventListener("click", showStats);
    backToQuizBtn.addEventListener("click", showQuiz);
    nextBtn.addEventListener("click", showNewQuestion);
    showBtn.addEventListener("click", showAnswer);
    correctBtn.addEventListener("click", () => recordAnswer(true));
    wrongBtn.addEventListener("click", () => recordAnswer(false));
    async function loadCardsFromJson() {
      try {
        const res = await fetch(categoryConfig.file);
        cards = await res.json();
        showNewQuestion();
      } catch (e) { qWordEl.textContent = "Error loading data."; }
    }
    loadCardsFromJson();
    window.addEventListener("pageshow", (e) => { if (e.persisted) location.reload(); });
  </script>
</body>
</html>